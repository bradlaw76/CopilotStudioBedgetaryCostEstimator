<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Studio Agent Cost Calculator v1.3.3.1</title>
    <!-- 
        APPLICATION: Copilot Studio Agent Cost Calculator
        VERSION: 1.3.3.1
        DOCUMENTATION:
            - Validated against "COB" Excel Source Files.
            - Standard Logic: (Graph*10 + Answers*2) * Convos
            - Autonomous Logic: (Triggers*7 + Deep*10 + Answers*2 + Flow*0.13) * Convos
            - Rollup: Daily * 22 Business Days = Monthly; Monthly * 12 = Annual.
            - Security: Added listeners to block context menu and save/view source shortcuts.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .bg-gradient { background: radial-gradient(circle at top right, #f0f9ff 0%, #e0f2fe 50%, #f1f5f9 100%); }
        input[type=range] { accent-color: #0284c7; }
        .tab-active { border-bottom: 3px solid #0284c7; color: #0f172a; font-weight: 600; }
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .enter-here { color: #0284c7; font-weight: 700; font-size: 0.70rem; animation: pulse 2s infinite; white-space: nowrap; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .mode-toggle { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .mode-active { background-color: #0284c7; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="bg-gradient min-h-screen text-slate-800 p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="relative text-center mb-8">
            <button onclick="toggleSettings(true)" class="absolute right-0 top-0 p-2 text-slate-400 hover:text-sky-600 transition-colors bg-white/50 rounded-xl border border-white shadow-sm" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div class="inline-flex items-center justify-center p-3 bg-sky-100 rounded-2xl mb-4 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </div>
            <h1 class="text-3xl font-bold tracking-tight text-slate-900 uppercase">Budgetary Cost Estimator</h1>
            <p class="text-slate-500 mt-1 italic text-sm">v1.3.3.1 • Validated Funding Projections</p>
            <div class="flex justify-center mt-6">
                <div class="bg-white/60 p-1 rounded-2xl border border-white flex shadow-sm">
                    <button id="mode-std" onclick="setMode('standard')" class="px-6 py-2 rounded-xl text-sm font-semibold mode-toggle mode-active">Standard Agents</button>
                    <button id="mode-auto" onclick="setMode('autonomous')" class="px-6 py-2 rounded-xl text-sm font-semibold mode-toggle text-slate-500">Autonomous Agents</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="flex justify-center space-x-8 mb-8 border-b border-slate-200">
            <button onclick="switchTab('calculator')" id="tab-calc" class="pb-3 px-2 tab-active transition-all">Calculator</button>
            <button onclick="switchTab('pricing')" id="tab-pricing" class="pb-3 px-2 text-slate-500 hover:text-slate-700 transition-all">Rates & Logic</button>
        </div>

        <div id="content-calculator" class="block">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Inputs Panel -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="card p-6 rounded-3xl shadow-xl border border-white">
                        <h2 class="text-lg font-semibold mb-6 flex items-center">
                            <span class="w-2 h-6 bg-sky-500 rounded-full mr-2"></span>
                            Deployment Scale
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-orange-50/50 p-4 rounded-2xl border border-orange-100">
                                <div class="flex justify-between mb-2 items-center">
                                    <label class="text-xs font-bold uppercase tracking-wider text-slate-500">Number of Agents</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="num_agents" value="10" oninput="syncInputs('agents', this.value)" class="w-16 p-1 text-right font-bold text-sky-600 bg-white border border-slate-200 rounded focus:ring-2 focus:ring-sky-500 outline-none">
                                        <span class="enter-here"><< enter here</span>
                                    </div>
                                </div>
                                <input type="range" id="agents" min="0" max="100" value="10" oninput="syncInputs('num_agents', this.value)" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div class="bg-orange-50/50 p-4 rounded-2xl border border-orange-100">
                                <div class="flex justify-between mb-2 items-center">
                                    <label class="text-xs font-bold uppercase tracking-wider text-slate-500">Convos / Agent / Day</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="num_convos" value="30" oninput="syncInputs('convos', this.value)" class="w-16 p-1 text-right font-bold text-sky-600 bg-white border border-slate-200 rounded focus:ring-2 focus:ring-sky-500 outline-none">
                                        <span class="enter-here"><< enter here</span>
                                    </div>
                                </div>
                                <input type="range" id="convos" min="0" max="500" value="30" oninput="syncInputs('num_convos', this.value)" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 rounded-3xl shadow-xl border border-white">
                        <h2 class="text-lg font-semibold mb-6 flex items-center">
                            <span class="w-2 h-6 bg-emerald-500 rounded-full mr-2"></span>
                            <span id="complexity-title">Session Profile</span>
                        </h2>
                        
                        <div id="standard-inputs" class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                <div class="bg-blue-50/30 p-4 rounded-2xl border border-blue-100/50">
                                    <div class="flex justify-between mb-2 items-center text-[10px] uppercase font-bold text-slate-400">
                                        <span>Graph Grounding</span>
                                        <input type="number" id="num_graph" value="3" oninput="syncInputs('graph', this.value)" class="w-12 p-1 text-right text-emerald-600 bg-white border border-slate-200 rounded">
                                    </div>
                                    <input type="range" id="graph" min="0" max="20" value="3" oninput="syncInputs('num_graph', this.value)" class="w-full h-1.5 mt-2">
                                </div>
                                <div class="bg-blue-50/30 p-4 rounded-2xl border border-blue-100/50">
                                    <div class="flex justify-between mb-2 items-center text-[10px] uppercase font-bold text-slate-400">
                                        <span>GenAI Answers</span>
                                        <input type="number" id="num_genai" value="4" oninput="syncInputs('genai', this.value)" class="w-12 p-1 text-right text-emerald-600 bg-white border border-slate-200 rounded">
                                    </div>
                                    <input type="range" id="genai" min="0" max="20" value="4" oninput="syncInputs('num_genai', this.value)" class="w-full h-1.5 mt-2">
                                </div>
                            </div>
                        </div>

                        <div id="autonomous-inputs" class="hidden space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-purple-50/30 p-4 rounded-2xl border border-purple-100">
                                    <div class="flex justify-between mb-2 items-center text-[10px] uppercase font-bold text-slate-400">
                                        <span>Auto Triggers</span>
                                        <input type="number" id="num_triggers" value="1" oninput="syncInputs('triggers', this.value)" class="w-12 p-1 text-right text-purple-600 rounded border border-slate-200">
                                    </div>
                                    <input type="range" id="triggers" min="0" max="10" value="1" oninput="syncInputs('num_triggers', this.value)" class="w-full h-1.5 mt-2">
                                </div>
                                <div class="bg-purple-50/30 p-4 rounded-2xl border border-purple-100">
                                    <div class="flex justify-between mb-2 items-center text-[10px] uppercase font-bold text-slate-400">
                                        <span>Reasoning steps (o1)</span>
                                        <input type="number" id="num_deep" value="2" oninput="syncInputs('deep', this.value)" class="w-12 p-1 text-right text-purple-600 rounded border border-slate-200">
                                    </div>
                                    <input type="range" id="deep" min="0" max="10" value="2" oninput="syncInputs('num_deep', this.value)" class="w-full h-1.5 mt-2">
                                </div>
                                <div class="bg-purple-50/30 p-4 rounded-2xl border border-purple-100">
                                    <div class="flex justify-between mb-2 items-center text-[10px] uppercase font-bold text-slate-400">
                                        <span>Flow Actions</span>
                                        <input type="number" id="num_flow" value="4" oninput="syncInputs('flow_slider', this.value)" class="w-12 p-1 text-right text-purple-600 rounded border border-slate-200">
                                    </div>
                                    <input type="range" id="flow_slider" min="0" max="20" value="4" oninput="syncInputs('num_flow', this.value)" class="w-full h-1.5 mt-2">
                                </div>
                                <div class="bg-purple-50/30 p-4 rounded-2xl border border-purple-100">
                                    <div class="flex justify-between mb-2 items-center text-[10px] uppercase font-bold text-slate-400">
                                        <span>GenAI Answers</span>
                                        <input type="number" id="num_auto_genai" value="4" oninput="syncInputs('auto_genai', this.value)" class="w-12 p-1 text-right text-purple-600 rounded border border-slate-200">
                                    </div>
                                    <input type="range" id="auto_genai" min="0" max="20" value="4" oninput="syncInputs('num_auto_genai', this.value)" class="w-full h-1.5 mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forecast Panel -->
                <div class="lg:col-span-5">
                    <div class="sticky top-8 space-y-4">
                        <div class="bg-slate-900 text-white p-8 rounded-3xl shadow-2xl relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-2">Fleet Annual Investment</p>
                                <div class="text-5xl font-bold mb-2" id="total_annual">$0.00</div>
                                <p class="text-slate-400 text-xs mb-8" id="calc_methodology">Estimated for funding purposes (<span class="val-days">22</span> days/mo)</p>
                                <div class="space-y-4 pt-6 border-t border-slate-700">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400 text-sm">Typical Agent Monthly</span>
                                        <span class="font-bold text-lg" id="agent_cost_monthly">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-400 text-sm">Daily Total Credits</span>
                                        <span class="font-semibold text-sky-400" id="total_msgs_daily">0</span>
                                    </div>
                                </div>
                                <button onclick="generateEmail()" class="w-full mt-8 bg-sky-600 hover:bg-sky-500 text-white font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2 shadow-lg group">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                    Generate Funding Draft
                                </button>
                            </div>
                            <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-sky-500/10 blur-3xl rounded-full"></div>
                        </div>
                        <div class="bg-white/70 border border-white p-6 rounded-3xl shadow-sm">
                            <h3 class="text-sm font-bold text-slate-900 mb-4 flex items-center uppercase tracking-widest border-b border-slate-100 pb-2">Calculation Breakdown</h3>
                            <div id="breakdown-container" class="space-y-3 text-xs"></div>
                            <div class="mt-6 pt-4 border-t border-slate-100 text-slate-500 text-[11px] leading-relaxed italic" id="summary_text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-pricing" class="hidden space-y-8 pb-12">
            <div class="card p-8 rounded-3xl shadow-xl border border-white">
                <h2 class="text-xl font-bold mb-6 text-slate-900">Logic Baseline (Jan 2026 Credits)</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-600">
                        <thead class="bg-slate-50"><tr class="border-b border-slate-200">
                            <th class="p-4 font-bold text-slate-900 rounded-tl-xl">Consumption Category</th>
                            <th class="p-4 font-bold text-slate-900 text-center">Standard Credit Burn</th>
                            <th class="p-4 font-bold text-slate-900 rounded-tr-xl">Logic Source Note</th>
                        </tr></thead>
                        <tbody id="rate-table-body"></tbody>
                    </table>
                </div>
                <div class="mt-6 p-4 bg-blue-50 border border-blue-100 rounded-xl text-xs text-blue-700 leading-relaxed">
                    <strong>Funding Disclaimer:</strong> These projections are estimated values for planning and budgetary funding purposes only. Actual consumption, runtime orchestration logic, and environment-specific patterns will result in expected differences in final billing.
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-slate-400 text-[10px] pb-10 flex flex-col gap-1 items-center italic">
            <span>Microsoft Copilot Studio • Consumption Modeling • 22 Business Day Run-rate</span>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 modal-overlay" onclick="toggleSettings(false)"></div>
        <div class="relative bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in duration-200">
            <div class="p-6 border-b flex justify-between items-center"><h2 class="text-xl font-bold">Calculation Logic Config</h2></div>
            <div class="p-6 space-y-8 max-h-[65vh] overflow-y-auto" id="settings-form">
                <div class="space-y-6">
                    <section><h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Core Billing</h3><div class="grid grid-cols-2 gap-4" id="section-billing"></div></section>
                    <section><h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Standard Agent Factors</h3><div class="grid grid-cols-2 gap-4" id="section-standard"></div></section>
                    <section><h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Autonomous Agent Factors</h3><div class="grid grid-cols-2 gap-4" id="section-autonomous"></div></section>
                </div>
            </div>
            <div class="p-6 border-t bg-slate-50 flex gap-3">
                <button onclick="resetDefaults()" class="py-3 px-4 rounded-xl font-semibold text-red-600 hover:bg-red-100 transition-colors">Reset Defaults</button>
                <div class="flex-1 flex gap-3">
                    <button onclick="toggleSettings(false)" class="flex-1 py-3 rounded-xl font-semibold text-slate-600 hover:bg-slate-200">Cancel</button>
                    <button onclick="saveSettings()" class="flex-1 py-3 rounded-xl font-semibold bg-sky-600 text-white hover:bg-sky-700 shadow-md">Apply & Persist</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Security logic to prevent unauthorized downloads/source viewing
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && ['s','u'].includes(e.key.toLowerCase())) {
                e.preventDefault();
            }
        });

        const DEFAULT_RATES = {
            days_per_month: 22, price_per_msg: 0.01,
            graph: 10, genai: 2, actions: 5, 
            triggers: 7, deep: 10, flow: 0.13
        };

        const LABELS = {
            days_per_month: "Business Days / Month", price_per_msg: "Credit Unit Price ($)",
            graph: "Standard Graph Burn", genai: "Standard GenAI Burn",
            actions: "Standard Action Burn", triggers: "Auto Trigger Burn",
            deep: "Reasoning Step Burn (o1)", flow: "Auto Flow Action Burn"
        };

        let currentMode = 'standard';
        const stored = JSON.parse(localStorage.getItem('copilot_rates_v4')) || {};
        let RATES = { ...DEFAULT_RATES, ...stored };

        function setMode(m) {
            currentMode = m;
            document.getElementById('mode-std').classList.toggle('mode-active', m === 'standard');
            document.getElementById('mode-auto').classList.toggle('mode-active', m === 'autonomous');
            document.getElementById('standard-inputs').classList.toggle('hidden', m === 'autonomous');
            document.getElementById('autonomous-inputs').classList.toggle('hidden', m === 'standard');
            document.getElementById('complexity-title').innerText = `Session Profile (${m === 'standard' ? 'Standard' : 'Autonomous'})`;
            calculate();
        }

        function syncInputs(id, val) {
            document.getElementById(id).value = val;
            calculate();
        }

        function populateRateTable() {
            const table = document.getElementById('rate-table-body');
            const data = [
                { type: 'Tenant Graph Grounding', rate: RATES.graph, note: 'Knowledge Retrieval' },
                { type: 'Generative Answers', rate: RATES.genai, note: 'Text/GenAI standard output' },
                { type: 'Autonomous Triggers', rate: RATES.triggers, note: 'Logic initiation credits' },
                { type: 'Deep Reasoning (o1)', rate: RATES.deep, note: 'Complex Orchestration steps' },
                { type: 'Agent Flow Actions', rate: RATES.flow, note: 'Power Automate integration' },
                { type: 'Credit Unit Price', rate: `$${RATES.price_per_msg}`, note: 'Per credit consumption unit' }
            ];
            table.innerHTML = data.map(r => `
                <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-colors">
                    <td class="p-4 font-medium text-slate-800">${r.type}</td>
                    <td class="p-4 text-center font-bold text-sky-600">${r.rate}</td>
                    <td class="p-4 text-slate-500 italic text-xs">${r.note}</td>
                </tr>
            `).join('');
        }

        function calculate() {
            const agents = parseFloat(document.getElementById('num_agents').value) || 0;
            const convos = parseFloat(document.getElementById('num_convos').value) || 0;
            
            let dailyTotalPerAgent = 0;
            let breakdownHtml = '';

            if (currentMode === 'standard') {
                const g = parseFloat(document.getElementById('num_graph').value) || 0;
                const a = parseFloat(document.getElementById('num_genai').value) || 0;
                const gBurn = g * RATES.graph * convos;
                const aBurn = a * RATES.genai * convos;
                dailyTotalPerAgent = gBurn + aBurn;
                breakdownHtml = `
                    <div class="flex justify-between"><span>Graph Grounding Daily</span><span class="font-bold">${Math.round(gBurn).toLocaleString()}</span></div>
                    <div class="flex justify-between"><span>Gen Answers Daily</span><span class="font-bold">${Math.round(aBurn).toLocaleString()}</span></div>
                `;
            } else {
                const t = parseFloat(document.getElementById('num_triggers').value) || 0;
                const d = parseFloat(document.getElementById('num_deep').value) || 0;
                const g = parseFloat(document.getElementById('num_auto_genai').value) || 0;
                const f = parseFloat(document.getElementById('num_flow').value) || 0;
                const tBurn = t * RATES.triggers * convos;
                const dBurn = d * RATES.deep * convos;
                const gBurn = g * RATES.genai * convos;
                const fBurn = f * RATES.flow * convos;
                dailyTotalPerAgent = tBurn + dBurn + gBurn + fBurn;
                breakdownHtml = `
                    <div class="flex justify-between"><span>Auto Triggers Daily</span><span class="font-bold">${Math.round(tBurn).toLocaleString()}</span></div>
                    <div class="flex justify-between"><span>Deep Reasoning Daily</span><span class="font-bold">${Math.round(dBurn).toLocaleString()}</span></div>
                    <div class="flex justify-between"><span>Gen Answers Daily</span><span class="font-bold">${Math.round(gBurn).toLocaleString()}</span></div>
                    <div class="flex justify-between"><span>Flow Actions Daily</span><span class="font-bold">${fBurn.toFixed(1)}</span></div>
                `;
            }

            breakdownHtml += `<div class="flex justify-between border-t border-slate-100 pt-2 font-bold text-sky-600 uppercase tracking-tighter"><span>Total Credits Daily / Agent</span><span>${Math.round(dailyTotalPerAgent).toLocaleString()}</span></div>`;
            document.getElementById('breakdown-container').innerHTML = breakdownHtml;

            const fleetDaily = dailyTotalPerAgent * agents;
            const monthlyCost = fleetDaily * RATES.days_per_month * RATES.price_per_msg;
            const annualCost = monthlyCost * 12;

            document.getElementById('total_annual').innerText = formatCurrency(annualCost);
            document.getElementById('agent_cost_monthly').innerText = agents > 0 ? formatCurrency(monthlyCost / agents) : "$0.00";
            document.getElementById('total_msgs_daily').innerText = Math.round(fleetDaily).toLocaleString();
            document.querySelectorAll('.val-days').forEach(el => el.innerText = RATES.days_per_month);
            
            document.getElementById('summary_text').innerText = `Estimated deployment of ${agents} ${currentMode} agents processing ${Math.round(fleetDaily).toLocaleString()} daily credits. Final monthly requirements may differ based on actual logic orchestration patterns.`;
            window.lastCalc = { agents, annualCost, monthlyCost, fleetDaily, mode: currentMode, burnPerConvo: dailyTotalPerAgent / convos || 0 };
        }

        function generateEmail() {
            const c = window.lastCalc;
            const subject = encodeURIComponent(`Budgetary Funding Estimate: Copilot Studio (${c.agents} Agents)`);
            const disclaimer = `Please note: This is an estimated value for funding and planning purposes only. There may be expected differences between these projections and actual billing based on the final agent orchestration logic and runtime usage environment. Official billing assumes a ${RATES.days_per_month}-day business month.`;
            const spacer = "\n".repeat(40);
            const techAudit = `[INTERNAL AUDIT: v1.3.3.1 | CONFIG: ${c.mode.toUpperCase()} | INTENSITY: ${c.burnPerConvo.toFixed(2)} | PRICE: ${RATES.price_per_msg} | CYCLE: ${RATES.days_per_month}]`;

            const body = encodeURIComponent(
                `Hi,\n\nI have prepared the budgetary funding estimates for our proposed Copilot Studio deployment. Below is the financial summary for the ${c.mode} agent pool:\n\n` +
                `Financial Projections:\n` +
                `-----------------------------------\n` +
                `• Number of Proposed Agents: ${c.agents}\n` +
                `• Estimated Annual Funding: ${formatCurrency(c.annualCost)}\n` +
                `• Estimated Monthly Operational Cost: ${formatCurrency(c.monthlyCost)}\n` +
                `• Projected Daily Credit Throughput: ${Math.round(c.fleetDaily).toLocaleString()}\n\n` +
                `${disclaimer}\n\n` +
                `Please let me know if you would like to proceed with the technical session profiling.\n\n` +
                `Best regards,` +
                `${spacer}\n` +
                `${techAudit}`
            );
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function formatCurrency(n) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n); }

        function toggleSettings(s) {
            const m = document.getElementById('settings-modal');
            if (s) {
                const createInput = (k) => `
                    <div class="flex flex-col p-2 bg-slate-50 border border-slate-100 rounded-lg">
                        <label class="text-[9px] font-bold uppercase text-slate-400 mb-1">${LABELS[k]}</label>
                        <input id="s_${k}" type="number" step="0.001" value="${RATES[k]}" class="w-full bg-transparent font-bold text-sky-700 outline-none text-sm">
                    </div>
                `;
                document.getElementById('section-billing').innerHTML = ['days_per_month', 'price_per_msg'].map(createInput).join('');
                document.getElementById('section-standard').innerHTML = ['graph', 'genai', 'actions'].map(createInput).join('');
                document.getElementById('section-autonomous').innerHTML = ['triggers', 'deep', 'flow'].map(createInput).join('');
                m.classList.remove('hidden');
            } else m.classList.add('hidden');
        }

        function saveSettings() {
            Object.keys(RATES).forEach(k => {
                const el = document.getElementById(`s_${k}`);
                if (el) RATES[k] = parseFloat(el.value);
            });
            localStorage.setItem('copilot_rates_v4', JSON.stringify(RATES));
            toggleSettings(false);
            populateRateTable();
            calculate();
        }

        function resetDefaults() {
            RATES = { ...DEFAULT_RATES };
            localStorage.removeItem('copilot_rates_v4');
            toggleSettings(false);
            populateRateTable();
            calculate();
        }

        function switchTab(t) {
            document.getElementById('tab-calc').classList.toggle('tab-active', t==='calculator');
            document.getElementById('tab-pricing').classList.toggle('tab-active', t==='pricing');
            document.getElementById('content-calculator').classList.toggle('hidden', t==='pricing');
            document.getElementById('content-pricing').classList.toggle('hidden', t==='calculator');
            if(t==='pricing') populateRateTable();
        }

        populateRateTable();
        calculate();
    </script>
</body>
</html>